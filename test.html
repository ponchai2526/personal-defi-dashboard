<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test Dashboard - Personal AI DeFi</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß™</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .title {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.2rem;
        }

        .test-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .test-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .wallet-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .network-selector {
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
        }

        .connect-button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .connect-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .connect-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-box {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .status-box.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-box.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-box.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .result-area {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .test-button {
            padding: 12px 24px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .test-button:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .info-card p {
            color: #666;
            line-height: 1.6;
        }

        .token-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .token-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .token-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .token-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .token-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 12px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .token-info h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #1f2937;
        }

        .token-info p {
            margin: 0;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .token-balance {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .token-value {
            font-size: 1rem;
            color: #059669;
            font-weight: 600;
        }

        .token-contract {
            font-size: 0.8rem;
            color: #9ca3af;
            font-family: monospace;
            margin-top: 10px;
            padding: 5px 8px;
            background: #f9fafb;
            border-radius: 4px;
        }

        .ai-analysis-section {
            margin-top: 25px;
            padding: 20px;
            background: #f0f9ff;
            border-radius: 12px;
            border: 1px solid #0ea5e9;
        }

        .ai-analysis-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .ai-analysis-content {
            color: #0c4a6e;
            line-height: 1.6;
        }

        .portfolio-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .summary-title {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
        }

        .no-tokens {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            font-size: 1.1rem;
        }

        .loading-tokens {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #6b7280;
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }

            .token-grid {
                grid-template-columns: 1fr;
            }

            .portfolio-summary {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üß™ Test Dashboard</h1>
            <p class="subtitle">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
        </div>

        <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ -->
        <div class="test-section">
            <h2 class="test-title">üì° Connection Status</h2>
            <div class="info-grid">
                <div class="info-card">
                    <h3>üåê Frontend</h3>
                    <p>Vercel: <span id="frontendStatus">Loading...</span></p>
                </div>
                <div class="info-card">
                    <h3>üß† Backend</h3>
                    <p>Replit: <span id="backendStatus">Loading...</span></p>
                </div>
                <div class="info-card">
                    <h3>üîó MetaMask</h3>
                    <p>Status: <span id="metamaskStatus">Loading...</span></p>
                </div>
            </div>
        </div>

        <!-- Wallet Connection -->
        <div class="test-section">
            <h2 class="test-title">ü¶ä Wallet Connection Test</h2>
            <div class="wallet-section">
                <select class="network-selector" id="networkSelector">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢</option>
                    <option value="0x1">Ethereum Mainnet</option>
                    <option value="0x89">Polygon</option>
                    <option value="0x38">BNB Smart Chain</option>
                    <option value="0xa4b1">Arbitrum</option>
                </select>
                <button class="connect-button" id="connectButton" onclick="connectWallet()">
                    <span id="connectButtonText">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MetaMask</span>
                </button>
            </div>
            <div id="walletStatus" class="status-box info" style="display: none;">
                <div id="walletStatusText">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>
            </div>
        </div>

        <!-- API Tests -->
        <div class="test-section">
            <h2 class="test-title">üîß API Tests</h2>
            <div>
                <button class="test-button" onclick="testBackendHealth()">
                    üè• Health Check
                </button>
                <button class="test-button" onclick="testNativeBalance()" disabled id="nativeBalanceBtn">
                    üí∞ Native Balance
                </button>
                <button class="test-button" onclick="testERC20Tokens()" disabled id="erc20TokensBtn">
                    ü™ô ERC-20 Tokens
                </button>
                <button class="test-button" onclick="testAIAnalysis()" disabled id="aiAnalysisBtn">
                    üß† AI Analysis
                </button>
                <button class="test-button" onclick="testNewFeatures()" disabled id="newFeaturesBtn">
                    üÜï New Features
                </button>
            </div>
            <div style="margin-bottom: 10px;">
                <button class="test-button" onclick="copyResults()" style="background: #17a2b8;">
                    üìã Copy Results
                </button>
                <button class="test-button" onclick="clearResults()" style="background: #dc3545;">
                    üóëÔ∏è Clear Results
                </button>
                <button class="test-button" onclick="runAllTests()" style="background: #fd7e14;">
                    üöÄ Run All Tests
                </button>
            </div>
            <div class="result-area" id="testResults">
                <div>üìù Test Results ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</div>
            </div>
        </div>

        <!-- Debug Info -->
        <div class="test-section">
            <h2 class="test-title">üîç Debug Information</h2>
            <div class="info-grid">
                <div class="info-card">
                    <h3>üìç URLs</h3>
                    <p>
                        <strong>Frontend:</strong> https://personal-defi-dashboard.vercel.app/<br>
                        <strong>Test Page:</strong> https://personal-defi-dashboard.vercel.app/test.html<br>
                        <strong>Backend:</strong> https://replit.com/@ponchai2526/my-python-backend-test
                    </p>
                </div>
                <div class="info-card">
                    <h3>üîë Current State</h3>
                    <p>
                        <strong>Account:</strong> <span id="currentAccount">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span><br>
                        <strong>Network:</strong> <span id="currentNetwork">‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö</span><br>
                        <strong>Balance:</strong> <span id="currentBalance">0</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===============================
        // Configuration
        // ===============================
        const BACKEND_URL = "https://838de3bd-02e7-4ba3-8bf0-63ab0412b36f-00-39zqf2mohnweu.pike.replit.dev";
        
        // State
        let currentAccount = null;
        let currentChainId = null;
        
        // Network Config
        const NETWORKS = {
            '0x1': { name: 'Ethereum', symbol: 'ETH' },
            '0x89': { name: 'Polygon', symbol: 'MATIC' },
            '0x38': { name: 'BNB Chain', symbol: 'BNB' },
            '0xa4b1': { name: 'Arbitrum', symbol: 'ETH' }
        };

        // ===============================
        // Initial Status Check
        // ===============================
        document.addEventListener('DOMContentLoaded', function() {
            checkInitialStatus();
        });

        function checkInitialStatus() {
            // Frontend Status
            document.getElementById('frontendStatus').textContent = '‚úÖ Active (Vercel)';
            
            // MetaMask Status
            if (typeof window.ethereum !== 'undefined') {
                document.getElementById('metamaskStatus').textContent = '‚úÖ Detected';
            } else {
                document.getElementById('metamaskStatus').textContent = '‚ùå Not Found';
            }
            
            // Backend Status - Test automatically
            testBackendHealth();
        }

        // ===============================
        // Wallet Connection
        // ===============================
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showWalletStatus('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á MetaMask', 'error');
                return;
            }

            try {
                document.getElementById('connectButtonText').textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...';
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (accounts.length === 0) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ account');
                }

                currentAccount = accounts[0];
                currentChainId = await window.ethereum.request({
                    method: 'eth_chainId'
                });

                // Update UI
                updateWalletInfo();
                showWalletStatus('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                
                // Enable API test buttons
                document.getElementById('nativeBalanceBtn').disabled = false;
                document.getElementById('erc20TokensBtn').disabled = false;
                document.getElementById('aiAnalysisBtn').disabled = false;
                document.getElementById('newFeaturesBtn').disabled = false;
                
                document.getElementById('connectButtonText').textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';

            } catch (error) {
                console.error('Connection error:', error);
                showWalletStatus(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
                document.getElementById('connectButtonText').textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MetaMask';
            }
        }

        function updateWalletInfo() {
            const network = NETWORKS[currentChainId];
            document.getElementById('currentAccount').textContent = `${currentAccount.substring(0, 6)}...${currentAccount.substring(currentAccount.length - 4)}`;
            document.getElementById('currentNetwork').textContent = network ? network.name : `Unknown (${currentChainId})`;
        }

        function showWalletStatus(message, type) {
            const statusBox = document.getElementById('walletStatus');
            const statusText = document.getElementById('walletStatusText');
            
            statusBox.className = `status-box ${type}`;
            statusText.textContent = message;
            statusBox.style.display = 'block';
        }

        // ===============================
        // API Tests
        // ===============================
        function logTest(message, type = 'info') {
            const resultsArea = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#17a2b8';
            
            resultsArea.innerHTML += `
                <div style="color: ${color}; margin-bottom: 5px;">
                    [${timestamp}] ${message}
                </div>
            `;
            resultsArea.scrollTop = resultsArea.scrollHeight;
        }

        // ===============================
        // Test Functions
        // ===============================
        async function testBackendHealth() {
            logTest('üè• Testing Backend Health...');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`);
                const data = await response.json();
                
                if (response.ok) {
                    logTest('‚úÖ Backend Health: OK', 'success');
                    logTest(`üìä Response: ${JSON.stringify(data, null, 2)}`);
                    document.getElementById('backendStatus').textContent = '‚úÖ Online (Replit)';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                logTest(`‚ùå Backend Health: ${error.message}`, 'error');
                document.getElementById('backendStatus').textContent = '‚ùå Offline';
            }
        }

        async function testNativeBalance() {
            if (!currentAccount || !currentChainId) {
                logTest('‚ùå Please connect wallet first', 'error');
                return;
            }

            logTest('üí∞ Testing Native Balance...');
            
            try {
                const response = await fetch(
                    `${BACKEND_URL}/api/get_advanced_dashboard?address=${currentAccount}&chainId=${currentChainId}`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    const balance = data.native_token?.data?.balance || 0;
                    const symbol = data.native_token?.data?.symbol || 'TOKEN';
                    
                    logTest(`‚úÖ Native Balance: ${balance.toFixed(6)} ${symbol}`, 'success');
                    document.getElementById('currentBalance').textContent = `${balance.toFixed(6)} ${symbol}`;
                    
                    // ‡πÅ‡∏™‡∏î‡∏á AI Analysis
                    if (data.native_token?.analysis) {
                        logTest('üß† AI Native Analysis:', 'success');
                        logTest(data.native_token.analysis, 'success');
                    }
                    
                    logTest(`üìä Full Native Response: ${JSON.stringify(data, null, 2)}`);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
            } catch (error) {
                logTest(`‚ùå Native Balance: ${error.message}`, 'error');
            }
        }

        async function testERC20Tokens() {
            if (!currentAccount || !currentChainId) {
                logTest('‚ùå Please connect wallet first', 'error');
                return;
            }

            if (currentChainId !== '0x89' && currentChainId !== '0x1') {
                logTest('‚ùå ERC-20 tokens only supported on Ethereum and Polygon', 'error');
                return;
            }

            logTest('ü™ô Testing ERC-20 Token Balances...');
            
            try {
                const response = await fetch(
                    `${BACKEND_URL}/api/get_token_balances?address=${currentAccount}&chainId=${currentChainId}`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    const tokens = data.token_balances?.tokens || [];
                    const stats = data.portfolio_stats || {};
                    
                    logTest(`‚úÖ ERC-20 Tokens: Found ${tokens.length} tokens`, 'success');
                    logTest(`üí∞ Total Token Value: $${stats.total_token_value?.toFixed(2) || 0}`, 'success');
                    logTest(`üìä Portfolio Stats: ${JSON.stringify(stats, null, 2)}`, 'success');
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ tokens
                    if (tokens.length > 0) {
                        logTest('üìã Token Holdings:');
                        tokens.forEach((token, index) => {
                            logTest(`${index + 1}. ${token.symbol} (${token.name}): ${token.balance_formatted} = $${token.value_usd?.toFixed(2) || 0}`, 'success');
                        });
                    }
                    
                    // ‡πÅ‡∏™‡∏î‡∏á AI Analysis
                    if (data.ai_analysis) {
                        logTest('üß† AI Portfolio Analysis:', 'success');
                        logTest(data.ai_analysis, 'success');
                    }
                    
                    // ‡πÅ‡∏™‡∏î‡∏á Token Display
                    displayTokens(data);
                    
                    logTest(`üìä Full ERC-20 Response: ${JSON.stringify(data, null, 2)}`);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
            } catch (error) {
                logTest(`‚ùå ERC-20 Tokens: ${error.message}`, 'error');
            }
        }

        async function testAIAnalysis() {
            if (!currentAccount || !currentChainId) {
                logTest('‚ùå Please connect wallet first', 'error');
                return;
            }

            logTest('üß† Testing AI Analysis...');
            
            try {
                const response = await fetch(
                    `${BACKEND_URL}/api/ai_portfolio_analysis?address=${currentAccount}&chainId=${currentChainId}`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    
                    logTest('‚úÖ AI Analysis completed', 'success');
                    logTest('üß† AI Insights:', 'success');
                    logTest(data.analysis || 'No analysis available', 'success');
                    
                    // ‡πÅ‡∏™‡∏î‡∏á recommendations
                    if (data.recommendations) {
                        logTest('üí° AI Recommendations:', 'success');
                        data.recommendations.forEach((rec, index) => {
                            logTest(`${index + 1}. ${rec}`, 'success');
                        });
                    }
                    
                    logTest(`üìä Full AI Response: ${JSON.stringify(data, null, 2)}`);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
            } catch (error) {
                logTest(`‚ùå AI Analysis: ${error.message}`, 'error');
            }
        }

        async function testNewFeatures() {
            logTest('üÜï Testing New Features...');
            
            // Test 1: Portfolio Tracking
            try {
                logTest('üìä Testing Portfolio Tracking...');
                const response = await fetch(`${BACKEND_URL}/api/portfolio_tracking`);
                const data = await response.json();
                
                logTest('‚úÖ Portfolio Tracking: Available', 'success');
                logTest(`üìà Features: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                logTest(`‚ùå Portfolio Tracking: ${error.message}`, 'error');
            }
            
            // Test 2: DeFi Analytics
            try {
                logTest('üè¶ Testing DeFi Analytics...');
                const response = await fetch(`${BACKEND_URL}/api/defi_analytics`);
                const data = await response.json();
                
                logTest('‚úÖ DeFi Analytics: Available', 'success');
                logTest(`üí° Analytics: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                logTest(`‚ùå DeFi Analytics: ${error.message}`, 'error');
            }
            
            // Test 3: Price Alerts
            try {
                logTest('üîî Testing Price Alerts...');
                const response = await fetch(`${BACKEND_URL}/api/price_alerts`);
                const data = await response.json();
                
                logTest('‚úÖ Price Alerts: Available', 'success');
                logTest(`üö® Alerts: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                logTest(`‚ùå Price Alerts: ${error.message}`, 'error');
            }
        }

        function displayTokens(data) {
            const tokens = data.token_balances?.tokens || [];
            const stats = data.portfolio_stats || {};
            const aiAnalysis = data.ai_analysis || '';
            
            // ‡∏•‡∏ö token display ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            const existingTokensDisplay = document.querySelector('.tokens-display');
            if (existingTokensDisplay) {
                existingTokensDisplay.remove();
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á tokens
            const tokensContainer = document.createElement('div');
            tokensContainer.className = 'tokens-display';
            tokensContainer.innerHTML = `
                <div style="margin-top: 25px; padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h3 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1.4rem;">
                        ü™ô ERC-20 Tokens Portfolio (${NETWORKS[currentChainId]?.name || 'Unknown'})
                    </h3>
                    
                    <!-- Portfolio Summary -->
                    <div class="portfolio-summary">
                        <div class="summary-card">
                            <div class="summary-title">Total Tokens</div>
                            <div class="summary-value">${tokens.length}</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-title">Total Value</div>
                            <div class="summary-value">$${stats.total_token_value?.toFixed(2) || '0.00'}</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-title">Diversity Score</div>
                            <div class="summary-value">${stats.diversity_score?.toFixed(1) || '0.0'}/10</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-title">Portfolio Value</div>
                            <div class="summary-value">$${stats.total_portfolio_value?.toFixed(2) || '0.00'}</div>
                        </div>
                    </div>
                    
                    <!-- Token Grid -->
                    <div class="token-grid">
                        ${tokens.length > 0 ? tokens.map(token => `
                            <div class="token-card">
                                <div class="token-header">
                                    <div class="token-icon">
                                        ${token.logo ? `<img src="${token.logo}" alt="${token.symbol}" style="width: 100%; height: 100%; border-radius: 50%;">` : 'ü™ô'}
                                    </div>
                                    <div class="token-info">
                                        <h3>${token.symbol}</h3>
                                        <p>${token.name}</p>
                                    </div>
                                </div>
                                <div class="token-balance">${token.balance_formatted}</div>
                                <div class="token-value">${token.value_usd?.toFixed(2) || '0.00'}</div>
                                <div class="token-contract">
                                    ${token.contract_address ? `${token.contract_address.substring(0, 8)}...${token.contract_address.substring(token.contract_address.length - 6)}` : 'N/A'}
                                </div>
                            </div>
                        `).join('') : `
                            <div class="no-tokens">
                                <div>üîç No tokens found</div>
                                <div style="margin-top: 10px; font-size: 0.9rem; color: #9ca3af;">
                                    Try connecting to a different network or check your wallet balance
                                </div>
                            </div>
                        `}
                    </div>
                    
                    <!-- AI Analysis Section -->
                    ${aiAnalysis ? `
                        <div class="ai-analysis-section">
                            <div class="ai-analysis-title">
                                üß† AI Portfolio Analysis
                            </div>
                            <div class="ai-analysis-content">
                                ${aiAnalysis}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° tokens display ‡∏´‡∏•‡∏±‡∏á test results
            const testSection = document.querySelector('.test-section:nth-child(4)');
            testSection.appendChild(tokensContainer);
        }

        // ===============================
        // Utility Functions
        // ===============================
        function copyResults() {
            const resultsArea = document.getElementById('testResults');
            const textContent = resultsArea.innerText;
            
            // Create a temporary textarea
            const textarea = document.createElement('textarea');
            textarea.value = textContent;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            // Show feedback
            const timestamp = new Date().toLocaleTimeString();
            resultsArea.innerHTML += `
                <div style="color: #28a745; margin-bottom: 5px; font-weight: bold;">
                    [${timestamp}] üìã Results copied to clipboard! ‚úÖ
                </div>
            `;
            resultsArea.scrollTop = resultsArea.scrollHeight;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '<div>üìù Test Results ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</div>';
            
            // ‡∏•‡∏ö token display ‡∏î‡πâ‡∏ß‡∏¢
            const existingTokensDisplay = document.querySelector('.tokens-display');
            if (existingTokensDisplay) {
                existingTokensDisplay.remove();
            }
            
            logTest('üóëÔ∏è Results cleared');
        }

        function runAllTests() {
            logTest('üöÄ Running all tests...');
            logTest('üìä Starting comprehensive test suite...');
            
            // Always run health check first
            testBackendHealth();
            
            // Run wallet-dependent tests if connected
            if (currentAccount && currentChainId) {
                setTimeout(() => testNativeBalance(), 2000);
                setTimeout(() => testERC20Tokens(), 4000);
                setTimeout(() => testAIAnalysis(), 6000);
                setTimeout(() => testNewFeatures(), 8000);
            } else {
                logTest('‚ö†Ô∏è Wallet not connected. Some tests will be skipped.', 'error');
                setTimeout(() => testNewFeatures(), 2000);
            }
            
            setTimeout(() => {
                logTest('üéâ All tests completed!', 'success');
                logTest('üìã You can now copy the results using the Copy Results button', 'success');
            }, 10000);
        }

        // ===============================
        // Event Listeners
        // ===============================
        
        // Listen for account changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    // User disconnected
                    currentAccount = null;
                    currentChainId = null;
                    document.getElementById('currentAccount').textContent = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                    document.getElementById('currentNetwork').textContent = '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
                    document.getElementById('currentBalance').textContent = '0';
                    document.getElementById('connectButtonText').textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MetaMask';
                    
                    // Disable test buttons
                    document.getElementById('nativeBalanceBtn').disabled = true;
                    document.getElementById('erc20TokensBtn').disabled = true;
                    document.getElementById('aiAnalysisBtn').disabled = true;
                    document.getElementById('newFeaturesBtn').disabled = true;
                    
                    showWalletStatus('‚ö†Ô∏è Wallet disconnected', 'error');
                    logTest('‚ö†Ô∏è Wallet disconnected', 'error');
                } else if (accounts[0] !== currentAccount) {
                    // Account changed
                    currentAccount = accounts[0];
                    updateWalletInfo();
                    logTest(`üîÑ Account changed to: ${currentAccount}`, 'info');
                }
            });

            // Listen for network changes
            window.ethereum.on('chainChanged', function (chainId) {
                currentChainId = chainId;
                updateWalletInfo();
                logTest(`üîÑ Network changed to: ${NETWORKS[chainId]?.name || 'Unknown'}`, 'info');
            });
        }

        // ===============================
        // Additional Features
        // ===============================
        
        // Auto-refresh functionality
        let autoRefreshInterval;
        
        function toggleAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                logTest('üîÑ Auto-refresh disabled', 'info');
            } else {
                autoRefreshInterval = setInterval(() => {
                    if (currentAccount && currentChainId) {
                        logTest('üîÑ Auto-refreshing data...', 'info');
                        testNativeBalance();
                        setTimeout(() => testERC20Tokens(), 1000);
                    }
                }, 30000); // Refresh every 30 seconds
                logTest('üîÑ Auto-refresh enabled (30s intervals)', 'info');
            }
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        runAllTests();
                        break;
                    case 'c':
                        if (e.shiftKey) {
                            e.preventDefault();
                            copyResults();
                        }
                        break;
                    case 'x':
                        e.preventDefault();
                        clearResults();
                        break;
                }
            }
        });

        // Add export functionality
        function exportResults() {
            const resultsArea = document.getElementById('testResults');
            const textContent = resultsArea.innerText;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            
            const blob = new Blob([textContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-results-${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logTest('üìÅ Results exported to file', 'success');
        }

        // Performance monitoring
        function monitorPerformance() {
            if (window.performance && window.performance.memory) {
                const memory = window.performance.memory;
                logTest(`üìä Memory Usage: ${(memory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`, 'info');
            }
            
            logTest(`‚è±Ô∏è Page Load Time: ${(performance.now() / 1000).toFixed(2)}s`, 'info');
        }

        // Add these functions to buttons (can be added dynamically)
        setTimeout(() => {
            const testSection = document.querySelector('.test-section:nth-child(4)');
            const buttonContainer = testSection.querySelector('div:nth-child(3)');
            
            buttonContainer.innerHTML += `
                <button class="test-button" onclick="toggleAutoRefresh()" style="background: #6f42c1;">
                    üîÑ Toggle Auto-Refresh
                </button>
                <button class="test-button" onclick="exportResults()" style="background: #e83e8c;">
                    üìÅ Export Results
                </button>
                <button class="test-button" onclick="monitorPerformance()" style="background: #20c997;">
                    üìä Performance
                </button>
            `;
        }, 1000);

        // Welcome message
        logTest('üéâ Test Dashboard loaded successfully!', 'success');
        logTest('üí° Tip: Use Ctrl+R to run all tests, Ctrl+Shift+C to copy results, Ctrl+X to clear', 'info');
        logTest('üîó Connect your wallet to enable all features', 'info');
    </script>
</body>
</html>
