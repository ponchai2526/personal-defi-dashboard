<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple DeFi Test</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin-top: 50px; background-color: #222; color: #eee; }
        button { padding: 10px 20px; font-size: 18px; cursor: pointer; background-color: #667eea; color: white; border: none; border-radius: 5px; }
        button:hover { background-color: #764ba2; }
        #walletInfo { margin-top: 20px; border: 1px solid #444; padding: 15px; border-radius: 8px; display: inline-block; }
        #walletAddress, #maticBalance, #networkName { font-weight: bold; color: #00d4ff; word-wrap: break-word; }
        #statusMessage { margin-top: 20px; font-size: 1.1em; }
    </style>
</head>
<body>
    <h1>Simple DeFi Test Dashboard</h1>
    <p>เชื่อมต่อ Wallet และดูยอด MATIC ของคุณ</p>

    <button id="connectWalletBtn">Connect MetaMask</button>

    <div id="walletInfo" style="display:none;">
        <p><strong>Connected Address:</strong> <span id="walletAddress">กำลังโหลด...</span></p>
        <p><strong>MATIC Balance:</strong> <span id="maticBalance">กำลังโหลด...</span></p>
        <p><strong>Network:</strong> <span id="networkName">กำลังโหลด...</span></p>
    </div>

    <p id="statusMessage"></p> <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.0/web3.min.js"></script>
    <script>
        let web3;
        let userAccount;

        // URL ของ Replit Backend ของคุณ
        // *** สำคัญมาก: คุณต้องเปลี่ยน URL นี้เป็น URL ของ Replit Project ของคุณจริงๆ นะครับ! ***
        const BACKEND_URL = "https://838de3bd-02e7-4ba3-8bf0-63ab0412b36f-00-39zqf2mohnweu.pike.replit.dev"; 

        // ฟังก์ชันหลักสำหรับเชื่อมต่อ MetaMask
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userAccount = accounts[0];
                    web3 = new Web3(window.ethereum);

                    const chainId = await web3.eth.getChainId();
                    // ตรวจสอบว่าอยู่บน Polygon Mainnet (Chain ID 137)
                    if (Number(chainId) !== 137) {
                        document.getElementById('statusMessage').textContent = 'กรุณาเปลี่ยนเป็น Polygon Mainnet เพื่อทดสอบ';
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: web3.utils.toHex(137) }],
                            });
                        } catch (e) { 
                            console.error('Error switching network:', e);
                            document.getElementById('statusMessage').textContent = 'ไม่สามารถเปลี่ยน Network ได้: ' + e.message;
                        }
                        return;
                    }

                    // อัปเดต UI เมื่อเชื่อมต่อสำเร็จ
                    document.getElementById('walletAddress').textContent = userAccount;
                    document.getElementById('networkName').textContent = 'Polygon Mainnet';
                    document.getElementById('walletInfo').style.display = 'block'; // แสดงข้อมูล Wallet
                    document.getElementById('connectWalletBtn').textContent = 'Connected ✅';
                    document.getElementById('connectWalletBtn').disabled = true; // ปิดปุ่ม

                    await loadMaticBalance(); // เรียกฟังก์ชันโหลด MATIC Balance

                } catch (error) {
                    console.error('MetaMask connection error:', error);
                    document.getElementById('statusMessage').textContent = 'Error เชื่อมต่อ MetaMask: ' + error.message;
                }
            } else {
                document.getElementById('statusMessage').textContent = 'กรุณาติดตั้ง MetaMask Extension';
            }
        }

        // ฟังก์ชันสำหรับโหลด MATIC Balance จาก Replit Backend
        async function loadMaticBalance() {
            document.getElementById('maticBalance').textContent = 'กำลังโหลด...';
            document.getElementById('statusMessage').textContent = ''; // ล้างข้อความเก่า

            try {
                // เรียก API จาก Replit Backend ของเรา
                const response = await fetch(`${BACKEND_URL}/api/wallet_data?address=${userAccount}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // ตรวจสอบว่าได้ข้อมูล MATIC มาถูกต้อง
                if (data.tokens && data.tokens.length > 0 && data.tokens[0].symbol === 'MATIC') {
                    document.getElementById('maticBalance').textContent = parseFloat(data.tokens[0].balance).toFixed(5) + ' MATIC';
                } else {
                    document.getElementById('maticBalance').textContent = 'ไม่พบข้อมูล MATIC.';
                }

            } catch (error) {
                console.error('Backend data fetch error:', error);
                document.getElementById('statusMessage').textContent = 'Error ดึง MATIC: ' + error.message;
                document.getElementById('maticBalance').textContent = 'ดึงข้อมูลไม่สำเร็จ.';
            }
        }

        // Event Listeners สำหรับการเปลี่ยนแปลงใน MetaMask
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) { location.reload(); } // ถ้า User ยกเลิกเชื่อมต่อ
                else { userAccount = accounts[0]; loadMaticBalance(); } // ถ้าเปลี่ยน Address
            });
            window.ethereum.on('chainChanged', function (chainId) {
                if (Number(chainId) === 137) { loadMaticBalance(); } // ถ้าเปลี่ยนเป็น Polygon
                else { alert('กรุณาเปลี่ยนเป็น Polygon Mainnet เพื่อทดสอบ'); }
            });
        }

        // เมื่อหน้าเว็บโหลดเสร็จ ให้ผูก Event Listener กับปุ่ม
        window.addEventListener('load', function() {
            const connectButton = document.getElementById('connectWalletBtn');
            if (connectButton) {
                connectButton.addEventListener('click', connectWallet);
            }
        });
    </script>
</body>
</html>
