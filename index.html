<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal DeFi Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- ‡∏™‡πà‡∏ß‡∏ô CSS ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) --- */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: #1e1e1e;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .header {
            background-color: #2a2a2a;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            color: #ffffff;
        }

        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #252525;
            font-size: 14px;
        }

        #walletAddress {
            font-family: monospace;
            background-color: #333;
            padding: 5px 10px;
            border-radius: 5px;
        }

        #connectButton {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #connectButton:hover {
            background-color: #0056b3;
        }

        .main-content {
            padding: 20px;
        }

        .section {
            background-color: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section h2 {
            margin-top: 0;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            font-size: 18px;
        }

        #tokenList {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #tokenList li {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #333;
        }
        #tokenList li:last-child {
            border-bottom: none;
        }

        .token-icon {
            width: 40px;
            height: 40px;
            margin-right: 15px;
        }

        .token-info {
            flex-grow: 1;
        }

        .token-symbol {
            font-weight: 700;
            display: block;
            font-size: 16px;
        }

        .token-name {
            font-size: 12px;
            color: #aaa;
        }

        .token-balance {
            text-align: right;
            font-weight: 700;
            font-size: 16px;
        }

        /* --- üß† ‡∏™‡πà‡∏ß‡∏ô CSS ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ AI --- */
        .ai-chat-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #aiQueryInput {
            width: calc(100% - 20px);
            padding: 10px;
            background-color: #333;
            border: 1px solid #555;
            border-radius: 5px;
            color: #e0e0e0;
            font-family: 'Sarabun', sans-serif;
        }

        #askAiButton {
            background-color: #8a2be2; /* ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI */
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 700;
        }

        #askAiButton:hover {
            background-color: #6a1eae;
        }
        
        #askAiButton:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        #aiResponseOutput {
            background-color: #1e1e1e;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
            min-height: 50px;
            white-space: pre-wrap; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ */
            font-size: 14px;
            color: #b0c4de; /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö */
        }
        /* --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô CSS ‡πÉ‡∏´‡∏°‡πà --- */

    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <h1>Personal DeFi Dashboard</h1>
        </header>
        <div class="wallet-info">
            <span id="walletAddress">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
            <button id="connectButton">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet</button>
        </div>
        <main class="main-content">
            <section class="section">
                <h2>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô Wallet</h2>
                <ul id="tokenList">
                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ó‡πÄ‡∏Ñ‡πá‡∏ô‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </ul>
            </section>
            
            <!-- --- üß† ‡∏™‡πà‡∏ß‡∏ô HTML ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ AI --- -->
            <section class="section">
                <h2>‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏±‡∏ö‡∏î‡∏ß‡∏á‡∏à‡∏¥‡∏ï‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤ (Gemini AI)</h2>
                <div class="ai-chat-container">
                    <input type="text" id="aiQueryInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...">
                    <button id="askAiButton" onclick="askGemini()">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</button>
                    <div id="aiResponseOutput">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å AI ‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</div>
                </div>
            </section>
            <!-- --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô HTML ‡πÉ‡∏´‡∏°‡πà --- -->

        </main>
    </div>

    <script>
        // --- ‡∏™‡πà‡∏ß‡∏ô JavaScript ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
        const connectButton = document.getElementById('connectButton');
        const walletAddressSpan = document.getElementById('walletAddress');
        const tokenList = document.getElementById('tokenList');
        // --- üß† ‡∏™‡πà‡∏ß‡∏ô JavaScript ‡πÉ‡∏´‡∏°‡πà ---
        const aiQueryInput = document.getElementById('aiQueryInput');
        const askAiButton = document.getElementById('askAiButton');
        const aiResponseOutput = document.getElementById('aiResponseOutput');
        // -----------------------

        // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á "‡∏™‡∏°‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏á" (Replit Backend)
        const BACKEND_URL = "https://838de3bd-02e7-4ba3-8bf0-63ab0412b36f-00-39zqf2mohnweu.pike.replit.dev";
        
        let currentAccount = null;

        connectButton.addEventListener('click', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    handleAccountsChanged(accounts);
                } catch (error) {
                    console.error("User rejected the request:", error);
                }
            } else {
                alert('‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á MetaMask!');
            }
        });

        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                console.log('Please connect to MetaMask.');
                walletAddressSpan.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                tokenList.innerHTML = '';
            } else if (accounts[0] !== currentAccount) {
                currentAccount = accounts[0];
                const shortAddress = `${currentAccount.substring(0, 6)}...${currentAccount.substring(currentAccount.length - 4)}`;
                walletAddressSpan.textContent = shortAddress;
                connectButton.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
                fetchWalletData(currentAccount);
            }
        }

        async function fetchWalletData(address) {
            tokenList.innerHTML = '<li>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</li>';
            try {
                const response = await fetch(`${BACKEND_URL}/api/wallet_data?address=${address}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                tokenList.innerHTML = ''; 
                if (data.tokens && data.tokens.length > 0) {
                    data.tokens.forEach(token => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <img src="https://cryptologos.cc/logos/polygon-matic-logo.png" alt="${token.name || 'Token'} icon" class="token-icon">
                            <div class="token-info">
                                <span class="token-symbol">${token.symbol}</span>
                                <span class="token-name">${token.name || 'Polygon'}</span>
                            </div>
                            <div class="token-balance">
                                <span>${token.balance}</span>
                            </div>
                        `;
                        tokenList.appendChild(li);
                    });
                } else {
                    tokenList.innerHTML = '<li>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ó‡πÄ‡∏Ñ‡πá‡∏ô</li>';
                }
            } catch (error) {
                console.error('Could not fetch wallet data:', error);
                tokenList.innerHTML = `<li>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</li>`;
            }
        }

        // --- üß† ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Gemini AI ---
        async function askGemini() {
            const query = aiQueryInput.value;
            if (!query) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                return;
            }

            // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
            askAiButton.disabled = true;
            askAiButton.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°...";
            aiResponseOutput.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏î‡∏ß‡∏á‡∏à‡∏¥‡∏ï‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤...";

            try {
                // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á Backend ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
                const response = await fetch(`${BACKEND_URL}/api/ask_gemini?query=${encodeURIComponent(query)}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
                aiResponseOutput.textContent = data.response;

            } catch (error) {
                console.error('Error asking Gemini:', error);
                aiResponseOutput.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
            } finally {
                // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                askAiButton.disabled = false;
                askAiButton.textContent = "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°";
            }
        }
        // --- ‡∏à‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà ---

    </script>
</body>

</html>
