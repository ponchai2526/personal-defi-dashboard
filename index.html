<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal AI Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 900px;
            margin: auto;
        }
        .header {
            text-align: center;
            padding: 20px 0;
        }
        .header h1 { margin: 0; font-size: 28px; }
        .wallet-info {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background-color: #161b22; border: 1px solid #30363d;
            border-radius: 8px; margin-bottom: 20px;
        }
        #walletAddress { font-family: monospace; }
        #connectButton {
            background-color: #238636; color: white; border: none;
            padding: 10px 18px; border-radius: 6px; cursor: pointer;
            font-weight: 700; transition: background-color 0.2s;
        }
        #connectButton:hover { background-color: #2ea043; }
        .section {
            background-color: #161b22; border: 1px solid #30363d;
            border-radius: 8px; margin-bottom: 20px; overflow: hidden;
        }
        .section-header {
            padding: 15px 20px; background-color: #1c2128;
            border-bottom: 1px solid #30363d;
        }
        .section-header h2 { margin: 0; font-size: 20px; }
        .section-content { padding: 20px; }
        .loading-state, .error-state, .empty-state {
            text-align: center; color: #8b949e; padding: 20px;
        }
        /* Token List Styles */
        .token-list { list-style-type: none; padding: 0; margin: 0; }
        .token-item {
            display: flex; align-items: center; padding: 12px 0;
            border-bottom: 1px solid #21262d;
        }
        .token-item:last-child { border-bottom: none; }
        .token-icon { width: 36px; height: 36px; margin-right: 15px; border-radius: 50%; }
        .token-info { flex-grow: 1; }
        .token-symbol { font-weight: 700; }
        .token-balance { font-weight: 700; font-size: 1.1em; }
        
        /* NFT Grid Styles */
        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }
        .nft-card {
            background-color: #0d1117; border-radius: 8px; overflow: hidden;
            border: 1px solid #30363d; text-align: center;
        }
        .nft-image { width: 100%; height: 120px; object-fit: cover; }
        .nft-name { padding: 8px; font-size: 12px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}

        /* AI Analysis Styles */
        .ai-analysis {
            margin-top: 20px; padding: 15px; background-color: rgba(35, 134, 54, 0.1);
            border-left: 3px solid #238636; border-radius: 0 6px 6px 0;
        }
        .ai-analysis p { margin: 0; line-height: 1.6; }
        .ai-title { font-weight: 700; color: #58a6ff; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Personal AI Dashboard</h1>
        </header>
        <div class="wallet-info">
            <span id="walletAddress">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
            <button id="connectButton">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet</button>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏Å -->
        <div id="dashboardContent">
            <!-- MATIC Section -->
            <section class="section">
                <div class="section-header"><h2>‡πÇ‡∏ó‡πÄ‡∏Ñ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (Native Token)</h2></div>
                <div class="section-content" id="maticSection">
                    <div class="loading-state">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet...</div>
                </div>
            </section>

            <!-- ERC-20 Section -->
            <section class="section">
                <div class="section-header"><h2>‡πÇ‡∏ó‡πÄ‡∏Ñ‡πá‡∏ô (ERC-20)</h2></div>
                <div class="section-content" id="erc20Section">
                    <div class="loading-state">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet...</div>
                </div>
            </section>

            <!-- NFT Section -->
            <section class="section">
                <div class="section-header"><h2>NFTs</h2></div>
                <div class="section-content" id="nftSection">
                    <div class="loading-state">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet...</div>
                </div>
            </section>
        </div>
    </div>

    <script>
        const connectButton = document.getElementById('connectButton');
        const walletAddressSpan = document.getElementById('walletAddress');
        const maticSection = document.getElementById('maticSection');
        const erc20Section = document.getElementById('erc20Section');
        const nftSection = document.getElementById('nftSection');

        const BACKEND_URL = "https://838de3bd-02e7-4ba3-8bf0-63ab0412b36f-00-39zqf2mohnweu.pike.replit.dev";
        let currentAccount = null;

        connectButton.addEventListener('click', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    handleAccountsChanged(accounts);
                } catch (error) { console.error("User rejected request:", error); }
            } else { alert('‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á MetaMask!'); }
        });

        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                currentAccount = null;
                walletAddressSpan.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                connectButton.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet';
                resetDashboard();
            } else if (accounts[0] !== currentAccount) {
                currentAccount = accounts[0];
                const shortAddress = `${currentAccount.substring(0, 6)}...${currentAccount.substring(currentAccount.length - 4)}`;
                walletAddressSpan.textContent = shortAddress;
                connectButton.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
                fetchFullDashboard(currentAccount);
            }
        }
        
        function resetDashboard() {
            maticSection.innerHTML = '<div class="loading-state">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet...</div>';
            erc20Section.innerHTML = '<div class="loading-state">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet...</div>';
            nftSection.innerHTML = '<div class="loading-state">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet...</div>';
        }

        function renderLoading(sectionElement) {
            sectionElement.innerHTML = '<div class="loading-state">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</div>';
        }
        
        function renderError(sectionElement, message) {
            sectionElement.innerHTML = `<div class="error-state">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${message}</div>`;
        }

        async function fetchFullDashboard(address) {
            renderLoading(maticSection);
            renderLoading(erc20Section);
            renderLoading(nftSection);

            try {
                const response = await fetch(`${BACKEND_URL}/api/get_full_dashboard?address=${address}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // Render MATIC
                if (data.matic && data.matic.data) {
                    maticSection.innerHTML = `
                        <ul class="token-list">
                            <li class="token-item">
                                <img src="${data.matic.data.icon}" class="token-icon">
                                <div class="token-info"><span class="token-symbol">${data.matic.data.symbol}</span></div>
                                <div class="token-balance"><span>${data.matic.data.balance}</span></div>
                            </li>
                        </ul>
                        <div class="ai-analysis">
                            <span class="ai-title">üß† ‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI:</span>
                            <p>${data.matic.analysis}</p>
                        </div>
                    `;
                } else {
                    renderError(maticSection, '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• MATIC ‡πÑ‡∏î‡πâ');
                }

                // Render ERC20
                if (data.erc20 && data.erc20.data) {
                    if (data.erc20.data.length > 0) {
                        let erc20Html = '<ul class="token-list">';
                        data.erc20.data.forEach(token => {
                            erc20Html += `
                                <li class="token-item">
                                    <img src="${token.icon}" onerror="this.src='https://etherscan.io/images/main/empty-token.png'" class="token-icon">
                                    <div class="token-info"><span class="token-symbol">${token.symbol}</span></div>
                                    <div class="token-balance"><span>${token.balance}</span></div>
                                </li>
                            `;
                        });
                        erc20Html += '</ul>';
                        erc20Html += `
                            <div class="ai-analysis">
                                <span class="ai-title">üß† ‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI:</span>
                                <p>${data.erc20.analysis}</p>
                            </div>
                        `;
                        erc20Section.innerHTML = erc20Html;
                    } else {
                        erc20Section.innerHTML = '<div class="empty-state">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ó‡πÄ‡∏Ñ‡πá‡∏ô ERC-20</div>';
                    }
                } else {
                     renderError(erc20Section, '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ERC-20 ‡πÑ‡∏î‡πâ');
                }

                // Render NFTs
                if (data.nfts && data.nfts.data) {
                     if (data.nfts.data.length > 0) {
                        let nftHtml = '<div class="nft-grid">';
                        data.nfts.data.forEach(nft => {
                            nftHtml += `
                                <div class="nft-card">
                                    <img src="${nft.image}" onerror="this.src='https://etherscan.io/images/main/empty-token.png'" class="nft-image">
                                    <div class="nft-name">${nft.name}</div>
                                </div>
                            `;
                        });
                        nftHtml += '</div>';
                        nftHtml += `
                            <div class="ai-analysis">
                                <span class="ai-title">üß† ‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI:</span>
                                <p>${data.nfts.analysis}</p>
                            </div>
                        `;
                        nftSection.innerHTML = nftHtml;
                    } else {
                        nftSection.innerHTML = '<div class="empty-state">‡πÑ‡∏°‡πà‡∏û‡∏ö NFT</div>';
                    }
                } else {
                    renderError(nftSection, '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• NFT ‡πÑ‡∏î‡πâ');
                }

            } catch (error) {
                console.error('Could not fetch full dashboard data:', error);
                renderError(maticSection, error.message);
                renderError(erc20Section, error.message);
                renderError(nftSection, error.message);
            }
        }
    </script>
</body>
</html>
