<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal AI Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí°</text></svg>">
    <style>
        /* ... CSS ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ... */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        :root { --dark-bg: #0d1117; --medium-bg: #161b22; --light-bg: #1c2128; --border-color: #30363d; --text-primary: #c9d1d9; --text-secondary: #8b949e; --accent-blue: #58a6ff; --accent-green: #238636; --accent-red: #da3633; --accent-orange: #f0883e; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--dark-bg); color: var(--text-primary); margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 900px; margin: auto; }
        .header { text-align: center; padding: 20px 0; }
        .header h1 { margin: 0; font-size: 28px; }
        .wallet-info { display: flex; justify-content: space-between; align-items: center; padding: 15px; background-color: var(--medium-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .wallet-details { display: flex; align-items: center; gap: 10px; }
        #walletAddress { font-family: monospace; }
        #networkName { background-color: var(--border-color); padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; border: 1px solid #4d545e; }
        #connectButton { background-color: var(--accent-green); color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-weight: 700; transition: background-color 0.2s; margin-top: 10px; width: 100%; }
        @media (min-width: 600px) { #connectButton { width: auto; margin-top: 0; } }
        .section { background-color: var(--medium-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .section-header { padding: 15px 20px; background-color: var(--light-bg); border-bottom: 1px solid var(--border-color); }
        .section-header h2 { margin: 0; font-size: 20px; }
        .section-content { padding: 20px; }
        .loading-state, .error-state { text-align: center; color: var(--text-secondary); padding: 40px 20px; }
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--accent-blue); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .token-list { list-style-type: none; padding: 0; margin: 0; }
        .token-item { display: flex; align-items: center; padding: 12px 0; }
        .token-icon { width: 36px; height: 36px; margin-right: 15px; border-radius: 50%; background-color: var(--dark-bg);}
        .token-info { flex-grow: 1; }
        .token-symbol { font-weight: 700; }
        .token-name { font-size: 12px; color: var(--text-secondary); }
        .token-balance { text-align: right; font-weight: 700; font-size: 1.1em; }
        .ai-analysis-container { margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .ai-analysis-item { padding: 15px; background-color: rgba(88, 166, 255, 0.1); border-left: 3px solid var(--accent-blue); border-radius: 0 6px 6px 0; margin-bottom: 10px; }
        .ai-analysis-item.quota-error { background-color: rgba(240, 136, 62, 0.1); border-left-color: var(--accent-orange); } /* ‚ú® ‡∏™‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ */
        .ai-analysis-item:last-child { margin-bottom: 0; }
        .ai-title { font-weight: 700; color: var(--accent-blue); display: block; margin-bottom: 5px; font-size: 14px; }
        .quota-error .ai-title { color: var(--accent-orange); } /* ‚ú® ‡∏™‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ */
        .ai-content { margin: 0; line-height: 1.6; }
        .ai-value { font-weight: 700; color: var(--text-primary); font-size: 1.2em; }
        .status-panel { display: flex; justify-content: space-between; flex-wrap: wrap; padding: 10px; margin-top: 20px; font-size: 12px; color: var(--text-secondary); }
        .status-item { display: flex; align-items: center; gap: 6px; margin-bottom: 5px; width: 50%; justify-content: flex-start; }
        @media (min-width: 600px) {
            .status-item {
                width: auto;
            }
        }
        .debug-log-container { margin-top: 20px; background-color: var(--medium-bg); border: 1px solid var(--border-color); border-radius: 8px; font-family: monospace; font-size: 12px; }
        .debug-log-header { padding: 10px 15px; background-color: var(--light-bg); border-bottom: 1px solid var(--border-color); font-weight: 700; }
        .debug-log-content { padding: 15px; height: 150px; overflow-y: auto; background-color: var(--dark-bg); color: var(--text-secondary); }
        .log-entry { margin-bottom: 5px; word-break: break-all; }
        .log-success { color: #3fb950; }
        .log-error { color: #f85149; }
        .log-info { color: #a371f7; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header"><h1>Personal AI Dashboard</h1></header>
        <div class="wallet-info"><div class="wallet-details"><span id="networkName"></span><span id="walletAddress">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span></div><button id="connectButton">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet</button></div>
        <div id="dashboardContent"><section class="section"><div class="section-header"><h2>‡πÇ‡∏ó‡πÄ‡∏Ñ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (Native Token)</h2></div><div class="section-content" id="mainTokenSection"><div class="loading-state">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet...</div></div></section></div>
        <div class="status-panel" id="systemStatus">
            <div class="status-item">Backend: <span id="status-Backend"></span></div>
            <div class="status-item">Alchemy: <span id="status-Alchemy"></span></div>
            <div class="status-item">Gemini AI: <span id="status-GeminiAI"></span></div>
            <div class="status-item">GitHub: <span id="status-GitHub"></span></div>
            <div class="status-item">Netlify: <span id="status-Netlify"></span></div>
            <div class="status-item">Browser: <span id="status-Browser"></span></div>
        </div>
        <div class="debug-log-container" id="debugLog" style="display: none;"><div class="debug-log-header">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Debug Log)</div><div class="debug-log-content" id="debugLogContent"></div></div>
    </div>

    <script>
        const connectButton = document.getElementById('connectButton');
        const walletAddressSpan = document.getElementById('walletAddress');
        const networkNameSpan = document.getElementById('networkName');
        const mainTokenSection = document.getElementById('mainTokenSection');
        const debugLogContainer = document.getElementById('debugLog');
        const debugLogContent = document.getElementById('debugLogContent');
        const BACKEND_URL = "https://838de3bd-02e7-4ba3-8bf0-63ab0412b36f-00-39zqf2mohnweu.pike.replit.dev";
        let currentAccount = null;

        function clearDebugLog() { debugLogContent.innerHTML = ''; debugLogContainer.style.display = 'none'; }
        function logDebug(message, type = 'info') { debugLogContainer.style.display = 'block'; const entry = document.createElement('div'); entry.className = `log-entry log-${type}`; entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`; debugLogContent.appendChild(entry); debugLogContent.scrollTop = debugLogContent.scrollHeight; }

        async function fetchFullDashboard(address) {
            clearDebugLog();
            logDebug('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£...');
            renderLoading(mainTokenSection);

            try {
                logDebug('1. [Frontend] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á Backend...');
                const response = await fetch(`${BACKEND_URL}/api/get_full_dashboard?address=${address}`);
                logDebug(`2. [Frontend] ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å Backend (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${response.status})`);

                const data = await response.json();

                if (response.status === 429 && data.reason === 'QUOTA_EXCEEDED') {
                    logDebug(`‚ùå ${data.details}`, 'error');
                    renderQuotaError(data);
                    return;
                }

                if (!response.ok) {
                    const errorMessage = `Backend ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏ó‡∏µ‡πà‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô: "${data.failed_at}". ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${data.details}`;
                    throw new Error(errorMessage);
                }

                logDebug('3. [Backend] ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Alchemy ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                logDebug('4. [Backend] ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢ Gemini AI ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                logDebug('5. [Frontend] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

                renderMainToken(data.matic);
                logDebug('‚úÖ ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!', 'success');

            } catch (error) {
                console.error('Could not fetch dashboard data:', error);
                renderError(mainTokenSection, `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î`);
                logDebug(`‚ùå ${error.message}`, 'error');
            }
        }

        function renderQuotaError(errorData) {
            mainTokenSection.innerHTML = `
                <div class="ai-analysis-container">
                    <div class="ai-analysis-item quota-error">
                        <span class="ai-title">‡∏û‡∏•‡∏±‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß üîã</span>
                        <p class="ai-content">
                            ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö
                            ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ
                            ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö
                        </p>
                    </div>
                </div>
            `;
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/health_check`);
                if (!response.ok) throw new Error('Health check failed');
                const status = await response.json();
                for (const service in status) {
                    if (status.hasOwnProperty(service)) {
                        updateStatusIndicator(service, status[service]);
                    }
                }
            } catch (error) {
                console.error("Could not check system status:", error);
                const services = ["Backend", "Alchemy", "Gemini AI", "GitHub", "Netlify", "Browser"];
                services.forEach(service => updateStatusIndicator(service, '‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'));
            }
        }

        function updateStatusIndicator(service, status) {
            const indicator = document.getElementById(`status-${service.replace(' ', '')}`);
            if (indicator) {
                indicator.textContent = status;
                if (status === "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß") {
                    indicator.style.color = 'var(--accent-green)';
                } else {
                    indicator.style.color = 'var(--accent-red)';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', checkSystemStatus);
        connectButton.addEventListener('click', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    handleAccountsChanged(accounts);
                } catch (error) {
                    console.error("User rejected request:", error);
                }
            } else {
                alert('‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á MetaMask!');
            }
        });
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', handleAccountsChanged);
            window.ethereum.on('chainChanged', () => window.location.reload());
        }
        function getNetworkName(chainId) {
            const networks = { '0x89': 'Polygon', '0x1': 'Ethereum', '0x38': 'BNB Chain', '0xa4b1': 'Arbitrum' };
            return networks[chainId] || 'Unknown';
        }
        async function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                currentAccount = null;
                walletAddressSpan.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                networkNameSpan.textContent = '';
                connectButton.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet';
                mainTokenSection.innerHTML = '<div class="loading-state">‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wallet...</div>';
                clearDebugLog();
            } else if (accounts[0] !== currentAccount) {
                currentAccount = accounts[0];
                walletAddressSpan.textContent = `${currentAccount.substring(0, 6)}...${currentAccount.substring(currentAccount.length - 4)}`;
                connectButton.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                networkNameSpan.textContent = getNetworkName(chainId);
                fetchFullDashboard(currentAccount);
            }
        }
        function renderLoading(sectionElement, text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...") {
            sectionElement.innerHTML = `<div class="loading-state"><div class="loader"></div><p>${text}</p></div>`;
        }
        function renderError(sectionElement, message) {
            sectionElement.innerHTML = `<div class="error-state">${message}</div>`;
        }
        function renderMainToken(tokenData) {
            if (tokenData && tokenData.data && tokenData.data.symbol) {
                const analysis = tokenData.analysis || {};
                const estimatedValue = parseFloat(analysis.estimated_usd || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                mainTokenSection.innerHTML = `<ul class="token-list"><li class="token-item"><img src="${tokenData.data.icon}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü™ô</text></svg>'" class="token-icon"><div class="token-info"><span class="token-symbol">${tokenData.data.symbol}</span><span class="token-name">${tokenData.data.name}</span></div><div class="token-balance"><span>${tokenData.data.balance}</span></div></li></ul><div class="ai-analysis-container"><div class="ai-analysis-item"><span class="ai-title">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span><p class="ai-content ai-value">${estimatedValue}</p></div><div class="ai-analysis-item"><span class="ai-title">üß† ‡∏ö‡∏ó‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å AI</span><p class="ai-content">${analysis.summary || 'N/A'}</p></div><div class="ai-analysis-item"><span class="ai-title">üí° ‡πÄ‡∏Å‡∏£‡πá‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ (Pro Tip)</span><p class="ai-content">${analysis.pro_tip || 'N/A'}</p></div></div>`;
            } else {
                renderError(mainTokenSection, '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ó‡πÄ‡∏Ñ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ');
            }
        }
    </script>
</body>
</html>
