<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🤖 AI Wallet Dashboard - Advanced Analytics</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🤖</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        /* ================== BASE STYLES ================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            color: #c9d1d9;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }
        
        /* ================== HEADER STYLES ================== */
        .header {
            text-align: center;
            padding: 30px 0;
            position: relative;
            background: rgba(22, 27, 34, 0.8);
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #30363d;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: clamp(24px, 5vw, 36px);
            background: linear-gradient(135deg, #58a6ff, #39d353);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header .subtitle {
            color: #8b949e;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        /* ================== SYSTEM STATUS ================== */
        .system-status {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(13, 17, 23, 0.8);
            border-radius: 20px;
            border: 1px solid #30363d;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-online { background: #39d353; }
        .status-warning { background: #f1c40f; }
        .status-error { background: #da3633; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ================== WALLET CONNECTION ================== */
        .wallet-connection {
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.9), rgba(30, 35, 42, 0.9));
            border: 1px solid #30363d;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .wallet-details {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .network-badge {
            background: linear-gradient(135deg, #30363d, #4d545e);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            border: 1px solid #4d545e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .wallet-address {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            background: rgba(13, 17, 23, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #21262d;
            color: #58a6ff;
        }
        
        .connect-btn {
            background: linear-gradient(135deg, #238636, #2ea043);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(35, 134, 54, 0.3);
        }
        
        .connect-btn:disabled {
            background: #30363d;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ================== SECTIONS ================== */
        .section {
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.9), rgba(30, 35, 42, 0.9));
            border: 1px solid #30363d;
            border-radius: 15px;
            margin-bottom: 30px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .section:hover {
            border-color: #4d545e;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .section-header {
            padding: 20px 25px;
            background: linear-gradient(135deg, rgba(28, 33, 40, 0.9), rgba(35, 40, 47, 0.9));
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header h2 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-content {
            padding: 25px;
        }
        
        /* ================== LOADING STATES ================== */
        .loading-state, .error-state, .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #8b949e;
        }
        
        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid #30363d;
            border-top: 4px solid #58a6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            margin-top: 15px;
        }
        
        .progress-bar {
            width: 200px;
            height: 4px;
            background: #30363d;
            border-radius: 2px;
            margin: 15px auto;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #39d353);
            width: 0%;
            animation: progress 3s ease-in-out infinite;
        }
        
        @keyframes progress {
            0%, 100% { width: 0%; }
            50% { width: 100%; }
        }
        
        /* ================== TOKEN LIST ================== */
        .token-list {
            list-style: none;
        }
        
        .token-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #21262d;
            transition: all 0.3s ease;
        }
        
        .token-item:last-child {
            border-bottom: none;
        }
        
        .token-item:hover {
            background: rgba(88, 166, 255, 0.05);
            border-radius: 8px;
            padding-left: 15px;
            padding-right: 15px;
            margin: 0 -15px;
        }
        
        .token-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 20px;
            background: #0d1117;
            border: 2px solid #30363d;
            transition: all 0.3s ease;
        }
        
        .token-item:hover .token-icon {
            border-color: #58a6ff;
            transform: scale(1.1);
        }
        
        .token-info {
            flex: 1;
        }
        
        .token-symbol {
            font-weight: 700;
            font-size: 16px;
            color: #f0f6fc;
        }
        
        .token-name {
            font-size: 14px;
            color: #8b949e;
            margin-top: 2px;
        }
        
        .token-balance {
            text-align: right;
            font-weight: 700;
            font-size: 18px;
            color: #39d353;
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* ================== NFT GRID ================== */
        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }
        
        .nft-card {
            background: linear-gradient(135deg, rgba(13, 17, 23, 0.9), rgba(21, 26, 33, 0.9));
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #30363d;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .nft-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: #58a6ff;
            box-shadow: 0 15px 35px rgba(88, 166, 255, 0.2);
        }
        
        .nft-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: linear-gradient(135deg, #21262d, #30363d);
            transition: all 0.3s ease;
        }
        
        .nft-card:hover .nft-image {
            transform: scale(1.05);
        }
        
        .nft-info {
            padding: 15px;
        }
        
        .nft-name {
            font-size: 14px;
            font-weight: 600;
            color: #f0f6fc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 5px;
        }
        
        .nft-collection {
            font-size: 12px;
            color: #8b949e;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* ================== AI ANALYSIS ================== */
        .ai-analysis {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(35, 134, 54, 0.1), rgba(57, 211, 83, 0.05));
            border-left: 4px solid #39d353;
            border-radius: 0 10px 10px 0;
            position: relative;
            overflow: hidden;
        }
        
        .ai-analysis::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(57, 211, 83, 0.05) 50%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }
        
        .ai-title {
            font-weight: 700;
            color: #58a6ff;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 16px;
            position: relative;
            z-index: 1;
        }
        
        .ai-content {
            position: relative;
            z-index: 1;
        }
        
        .ai-summary {
            line-height: 1.7;
            margin: 12px 0;
            color: #e6edf3;
        }
        
        .ai-badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .ai-badge {
            padding: 6px 12px;
            background: linear-gradient(135deg, #30363d, #4d545e);
            border: 1px solid #4d545e;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            color: #f0f6fc;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .risk-low { border-color: #39d353; color: #39d353; }
        .risk-medium { border-color: #f1c40f; color: #f1c40f; }
        .risk-high { border-color: #da3633; color: #da3633; }
        
        /* ================== DATA FLOW INDICATOR ================== */
        .data-flow {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(22, 27, 34, 0.95);
            border: 1px solid #30363d;
            border-radius: 10px;
            padding: 15px;
            font-size: 12px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            max-width: 250px;
        }
        
        .flow-step {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
            padding: 5px 8px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .flow-step.active {
            background: rgba(88, 166, 255, 0.1);
            border-left: 3px solid #58a6ff;
        }
        
        .flow-step.success {
            background: rgba(57, 211, 83, 0.1);
            border-left: 3px solid #39d353;
        }
        
        .flow-step.error {
            background: rgba(218, 54, 51, 0.1);
            border-left: 3px solid #da3633;
        }
        
        /* ================== RESPONSIVE DESIGN ================== */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .wallet-info {
                flex-direction: column;
                align-items: stretch;
            }
            
            .connect-btn {
                width: 100%;
                margin-top: 15px;
            }
            
            .nft-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 15px;
            }
            
            .data-flow {
                display: none;
            }
            
            .system-status {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        /* ================== ANIMATIONS ================== */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .slide-in {
            animation: slideIn 0.8s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <header class="header fade-in">
            <h1>🤖 AI Wallet Dashboard</h1>
            <p class="subtitle">Advanced Blockchain Analytics with AI-Powered Insights</p>
            
            <!-- System Status Indicators -->
            <div class="system-status">
                <div class="status-item">
                    <div class="status-indicator status-online" id="backendStatus"></div>
                    <span>Backend</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator status-error" id="alchemyStatus"></div>
                    <span>Alchemy API</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator status-warning" id="geminiStatus"></div>
                    <span>Gemini AI</span>
                </div>
            </div>
        </header>

        <!-- Wallet Connection Section -->
        <section class="wallet-connection slide-in">
            <div class="wallet-info">
                <div class="wallet-details">
                    <div class="network-badge" id="networkBadge">ยังไม่เชื่อมต่อ</div>
                    <div class="wallet-address" id="walletAddress">กรุณาเชื่อมต่อ MetaMask</div>
                </div>
                <button class="connect-btn" id="connectButton">🔗 เชื่อมต่อ Wallet</button>
            </div>
        </section>

        <!-- Data Flow Indicator -->
        <div class="data-flow" id="dataFlow">
            <div style="font-weight: 600; margin-bottom: 10px; color: #58a6ff;">📡 Data Flow</div>
            <div class="flow-step" id="flow1">🌐 Browser → Backend</div>
            <div class="flow-step" id="flow2">🔗 Backend → Alchemy</div>
            <div class="flow-step" id="flow3">⛓️ Alchemy → Backend</div>
            <div class="flow-step" id="flow4">🧠 Backend → Gemini AI</div>
            <div class="flow-step" id="flow5">🤖 AI → Backend</div>
            <div class="flow-step" id="flow6">📊 Backend → Browser</div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent">
            <!-- MATIC Section -->
            <section class="section fade-in">
                <div class="section-header">
                    <h2>⚡ โทเค็นหลัก (MATIC)</h2>
                    <div id="maticCount" style="font-size: 14px; color: #8b949e;"></div>
                </div>
                <div class="section-content" id="maticSection">
                    <div class="loading-state">
                        <div class="loader"></div>
                        <div class="loading-text">รอการเชื่อมต่อ Wallet...</div>
                    </div>
                </div>
            </section>

            <!-- ERC-20 Tokens Section -->
            <section class="section fade-in">
                <div class="section-header">
                    <h2>🪙 โทเค็น ERC-20</h2>
                    <div id="tokenCount" style="font-size: 14px; color: #8b949e;"></div>
                </div>
                <div class="section-content" id="erc20Section">
                    <div class="loading-state">
                        <div class="loader"></div>
                        <div class="loading-text">รอการเชื่อมต่อ Wallet...</div>
                    </div>
                </div>
            </section>

            <!-- NFTs Section -->
            <section class="section fade-in">
                <div class="section-header">
                    <h2>🎨 NFT Collection</h2>
                    <div id="nftCount" style="font-size: 14px; color: #8b949e;"></div>
                </div>
                <div class="section-content" id="nftSection">
                    <div class="loading-state">
                        <div class="loader"></div>
                        <div class="loading-text">รอการเชื่อมต่อ Wallet...</div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // ================== CONFIGURATION ==================
        const CONFIG = {
            BACKEND_URL: "https://your-replit-backend-url.replit.dev", // เปลี่ยนเป็น URL ของ Backend จริง
            SUPPORTED_NETWORKS: {
                '0x89': 'Polygon',
                '0x1': 'Ethereum',
                '0x38': 'BSC',
                '0xa4b1': 'Arbitrum'
            },
            REFRESH_INTERVAL: 30000, // 30 seconds
            API_TIMEOUT: 30000 // 30 seconds
        };

        // ================== GLOBAL STATE ==================
        let currentAccount = null;
        let systemStatus = {
            backend: false,
            alchemy: false,
            gemini: false
        };
        let isLoading = false;

        // ================== DOM ELEMENTS ==================
        const elements = {
            connectButton: document.getElementById('connectButton'),
            walletAddress: document.getElementById('walletAddress'),
            networkBadge: document.getElementById('networkBadge'),
            maticSection: document.getElementById('maticSection'),
            erc20Section: document.getElementById('erc20Section'),
            nftSection: document.getElementById('nftSection'),
            tokenCount: document.getElementById('tokenCount'),
            nftCount: document.getElementById('nftCount'),
            maticCount: document.getElementById('maticCount'),
            backendStatus: document.getElementById('backendStatus'),
            alchemyStatus: document.getElementById('alchemyStatus'),
            geminiStatus: document.getElementById('geminiStatus'),
            dataFlow: document.getElementById('dataFlow')
        };

        // ================== UTILITY FUNCTIONS ==================
        function updateFlowStep(stepId, status) {
            const step = document.getElementById(stepId);
            if (step) {
                step.className = `flow-step ${status}`;
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'error' ? 'rgba(218, 54, 51, 0.9)' : 'rgba(35, 134, 54, 0.9)'};
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                backdrop-filter: blur(10px);
                border: 1px solid ${type === 'error' ? '#da3633' : '#238636'};
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function formatAddress(address) {
            if (!address) return 'ไม่ได้เชื่อมต่อ';
            return `${address.substring(0, 8)}...${address.substring(address.length - 6)}`;
        }

        function renderLoadingState(element, message = "กำลังดึงข้อมูล...") {
            element.innerHTML = `
                <div class="loading-state">
                    <div class="loader"></div>
                    <div class="loading-text">${message}</div>
                    <div class="progress-bar"><div class="progress-fill"></div></div>
                </div>
            `;
        }

        function renderErrorState(element, message) {
            element.innerHTML = `
                <div class="error-state">
                    <div style="font-size: 48px; margin-bottom: 15px;">⚠️</div>
                    <div style="font-weight: 600; margin-bottom: 10px;">เกิดข้อผิดพลาด</div>
                    <div style="color: #da3633;">${message}</div>
                </div>
            `;
        }

        function renderEmptyState(element, message, icon = "📭") {
            element.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 48px; margin-bottom: 15px;">${icon}</div>
                    <div style="font-weight: 600; color: #8b949e;">${message}</div>
                </div>
            `;
        }

        // ================== API FUNCTIONS ==================
        async function checkSystemHealth() {
            try {
                updateFlowStep('flow1', 'active');
                
                const response = await fetch(`${CONFIG.BACKEND_URL}/api/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: AbortSignal.timeout(CONFIG.API_TIMEOUT)
                });

                if (response.ok) {
                    const data = await response.json();
                    systemStatus = {
                        backend: true,
                        alchemy: data.services?.alchemy || false,
                        gemini: data.services?.gemini || false
                    };
                    updateFlowStep('flow1', 'success');
                    updateSystemStatusUI();
                    return true;
                } else {
                    throw new Error(`Health check failed: ${response.status}`);
                }
            } catch (error) {
                console.error('Health check failed:', error);
                updateFlowStep('flow1', 'error');
                systemStatus.backend = false;
                updateSystemStatusUI();
                return false;
            }
        }

        function updateSystemStatusUI() {
            elements.backendStatus.className = `status-indicator ${systemStatus.backend ? 'status-online' : 'status-error'}`;
            elements.alchemyStatus.className = `status-indicator ${systemStatus.alchemy ? 'status-online' : 'status-error'}`;
            elements.geminiStatus.className = `status-indicator ${systemStatus.gemini ? 'status-online' : 'status-warning'}`;
        }

        async function fetchWalletDashboard(address) {
            if (!systemStatus.backend) {
                throw new Error('Backend service not available');
            }

            try {
                updateFlowStep('flow2', 'active');
                
                const response = await fetch(`${CONFIG.BACKEND_URL}/api/get_full_dashboard?address=${address}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: AbortSignal.timeout(CONFIG.API_TIMEOUT)
                });

                updateFlowStep('flow2', 'success');
                updateFlowStep('flow3', 'success');
                updateFlowStep('flow4', 'success');
                updateFlowStep('flow5', 'success');
                updateFlowStep('flow6', 'active');

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const data = await response.json();
                updateFlowStep('flow6', 'success');
                
                console.log('Dashboard data received:', data);
                return data;

            } catch (error) {
                updateFlowStep('flow6', 'error');
                throw error;
            }
        }

        // ================== RENDERING FUNCTIONS ==================
        function renderMaticData(maticData) {
            if (!maticData.data || !maticData.data.symbol) {
                renderEmptyState(elements.maticSection, "ไม่พบยอดคงเหลือ MATIC", "⚡");
                elements.maticCount.textContent = "";
                return;
            }

            const data = maticData.data;
            const analysis = maticData.analysis || {};
            
            elements.maticCount.textContent = `${data.balance} ${data.symbol}`;

            let html = `
                <ul class="token-list">
                    <li class="token-item">
                        <img src="${data.icon}" 
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>'" 
                             class="token-icon">
                        <div class="token-info">
                            <div class="token-symbol">${data.symbol}</div>
                            <div class="token-name">${data.name}</div>
                        </div>
                        <div class="token-balance">${data.balance}</div>
                    </li>
                </ul>
            `;

            // Add AI analysis if available
            if (analysis.summary) {
                html += `
                    <div class="ai-analysis">
                        <div class="ai-title">
                            🧠 AI Analysis
                            <span style="font-size: 12px; opacity: 0.7;">(Gemini AI)</span>
                        </div>
                        <div class="ai-content">
                            <div class="ai-summary">${analysis.summary}</div>
                            <div class="ai-badges">
                                ${analysis.status ? `<div class="ai-badge">${analysis.status}</div>` : ''}
                                ${analysis.recommendation ? `<div class="ai-badge">${analysis.recommendation}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            elements.maticSection.innerHTML = html;
        }

        function renderErc20Data(erc20Data) {
            if (!erc20Data.data || erc20Data.data.length === 0) {
                renderEmptyState(elements.erc20Section, "ไม่พบโทเค็น ERC-20", "🪙");
                elements.tokenCount.textContent = "0 โทเค็น";
                return;
            }

            const tokens = erc20Data.data;
            const analysis = erc20Data.analysis || {};
            
            elements.tokenCount.textContent = `${tokens.length} โทเค็น`;

            let html = '<ul class="token-list">';
            
            tokens.forEach(token => {
                html += `
                    <li class="token-item">
                        <img src="${token.icon}" 
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🪙</text></svg>'" 
                             class="token-icon">
                        <div class="token-info">
                            <div class="token-symbol">${token.symbol}</div>
                            <div class="token-name">${token.name}</div>
                        </div>
                        <div class="token-balance">${token.balance}</div>
                    </li>
                `;
            });
            
            html += '</ul>';

            // Add AI analysis
            if (analysis.summary) {
                let riskClass = '';
                if (analysis.risk_level) {
                    riskClass = `risk-${analysis.risk_level.toLowerCase()}`;
                }

                html += `
                    <div class="ai-analysis">
                        <div class="ai-title">
                            🧠 AI Portfolio Analysis
                            <span style="font-size: 12px; opacity: 0.7;">(Gemini AI)</span>
                        </div>
                        <div class="ai-content">
                            <div class="ai-summary">${analysis.summary}</div>
                            <div class="ai-badges">
                                ${analysis.style ? `<div class="ai-badge">📊 ${analysis.style}</div>` : ''}
                                ${analysis.risk_level ? `<div class="ai-badge ${riskClass}">⚡ ${analysis.risk_level} Risk</div>` : ''}
                                ${analysis.diversity_score ? `<div class="ai-badge">🎯 Diversity: ${analysis.diversity_score}/10</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            elements.erc20Section.innerHTML = html;
        }

        function renderNftData(nftData) {
            if (!nftData.data || nftData.data.length === 0) {
                renderEmptyState(elements.nftSection, "ไม่พบ NFT ในคอลเลกชัน", "🎨");
                elements.nftCount.textContent = "0 NFTs";
                return;
            }

            const nfts = nftData.data;
            const analysis = nftData.analysis || {};
            
            elements.nftCount.textContent = `${nfts.length} NFTs`;

            let html = '<div class="nft-grid">';
            
            nfts.forEach(nft => {
                html += `
                    <div class="nft-card" title="${nft.description || nft.name}">
                        <img src="${nft.image}" 
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎨</text></svg>'" 
                             class="nft-image" 
                             loading="lazy">
                        <div class="nft-info">
                            <div class="nft-name">${nft.name}</div>
                            <div class="nft-collection">${nft.collection}</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';

            // Add AI analysis
            if (analysis.highlight) {
                html += `
                    <div class="ai-analysis">
                        <div class="ai-title">
                            🧠 AI Collection Analysis
                            <span style="font-size: 12px; opacity: 0.7;">(Gemini AI)</span>
                        </div>
                        <div class="ai-content">
                            <div class="ai-summary">${analysis.highlight}</div>
                            <div class="ai-badges">
                                ${analysis.category ? `<div class="ai-badge">🎭 ${analysis.category}</div>` : ''}
                                ${analysis.collector_type ? `<div class="ai-badge">👤 ${analysis.collector_type}</div>` : ''}
                                ${analysis.diversity_score ? `<div class="ai-badge">🌈 Diversity: ${analysis.diversity_score}/10</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            elements.nftSection.innerHTML = html;
        }

        // ================== WALLET CONNECTION ==================
        async function connectWallet() {
            if (!window.ethereum) {
                showNotification('กรุณาติดตั้ง MetaMask เพื่อใช้งาน', 'error');
                return;
            }

            try {
                elements.connectButton.disabled = true;
                elements.connectButton.textContent = '🔄 กำลังเชื่อมต่อ...';

                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (accounts.length > 0) {
                    await handleAccountsChanged(accounts);
                    showNotification('เชื่อมต่อ Wallet สำเร็จ!', 'success');
                }
            } catch (error) {
                console.error('Connection failed:', error);
                showNotification('การเชื่อมต่อล้มเหลว: ' + error.message, 'error');
            } finally {
                elements.connectButton.disabled = false;
            }
        }

        async function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                // Disconnected
                currentAccount = null;
                elements.walletAddress.textContent = 'กรุณาเชื่อมต่อ MetaMask';
                elements.networkBadge.textContent = 'ยังไม่เชื่อมต่อ';
                elements.connectButton.textContent = '🔗 เชื่อมต่อ Wallet';
                resetDashboard();
                return;
            }

            if (accounts[0] !== currentAccount) {
                currentAccount = accounts[0];
                elements.walletAddress.textContent = formatAddress(currentAccount);
                elements.connectButton.textContent = '✅ เชื่อมต่อแล้ว';

                // Get network info
                try {
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    const networkName = CONFIG.SUPPORTED_NETWORKS[chainId] || 'Unknown Network';
                    elements.networkBadge.textContent = networkName;

                    if (chainId !== '0x89') {
                        showNotification('⚠️ แนะนำให้ใช้ Polygon Network สำหรับประสิทธิภาพที่ดีที่สุด', 'warning');
                    }
                } catch (error) {
                    console.error('Failed to get network:', error);
                }

                // Load dashboard data
                await loadDashboardData(currentAccount);
            }
        }

        async function loadDashboardData(address) {
            if (isLoading) return;
            
            isLoading = true;
            
            try {
                // Reset flow indicators
                for (let i = 1; i <= 6; i++) {
                    updateFlowStep(`flow${i}`, '');
                }

                // Show loading states
                renderLoadingState(elements.maticSection, "กำลังดึงข้อมูล MATIC...");
                renderLoadingState(elements.erc20Section, "กำลังดึงข้อมูลโทเค็น ERC-20...");
                renderLoadingState(elements.nftSection, "กำลังดึงข้อมูล NFTs...");

                // Check system health first
                const healthOk = await checkSystemHealth();
                if (!healthOk) {
                    throw new Error('System health check failed');
                }

                // Fetch dashboard data
                const dashboardData = await fetchWalletDashboard(address);

                // Render all sections
                renderMaticData(dashboardData.matic);
                renderErc20Data(dashboardData.erc20);
                renderNftData(dashboardData.nfts);

                console.log('Dashboard loaded successfully:', dashboardData);

            } catch (error) {
                console.error('Failed to load dashboard:', error);
                
                renderErrorState(elements.maticSection, error.message);
                renderErrorState(elements.erc20Section, error.message);
                renderErrorState(elements.nftSection, error.message);
                
                showNotification('ไม่สามารถโหลดข้อมูลได้: ' + error.message, 'error');
                
                // Reset flow on error
                for (let i = 1; i <= 6; i++) {
                    updateFlowStep(`flow${i}`, 'error');
                }
            } finally {
                isLoading = false;
            }
        }

        function resetDashboard() {
            renderLoadingState(elements.maticSection, "รอการเชื่อมต่อ Wallet...");
            renderLoadingState(elements.erc20Section, "รอการเชื่อมต่อ Wallet...");
            renderLoadingState(elements.nftSection, "รอการเชื่อมต่อ Wallet...");
            
            elements.tokenCount.textContent = "";
            elements.nftCount.textContent = "";
            elements.maticCount.textContent = "";

            // Reset flow indicators
            for (let i = 1; i <= 6; i++) {
                updateFlowStep(`flow${i}`, '');
            }
        }

        // ================== EVENT LISTENERS ==================
        elements.connectButton.addEventListener('click', connectWallet);

        // MetaMask event listeners
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', handleAccountsChanged);
            window.ethereum.on('chainChanged', (chainId) => {
                const networkName = CONFIG.SUPPORTED_NETWORKS[chainId] || 'Unknown Network';
                elements.networkBadge.textContent = networkName;
                
                if (currentAccount) {
                    loadDashboardData(currentAccount);
                }
            });
            window.ethereum.on('disconnect', () => {
                currentAccount = null;
                resetDashboard();
                showNotification('Wallet disconnected', 'warning');
            });
        }

        // Auto-refresh dashboard
        setInterval(() => {
            if (currentAccount && !isLoading) {
                console.log('Auto-refreshing dashboard data...');
                loadDashboardData(currentAccount);
            }
        }, CONFIG.REFRESH_INTERVAL);

        // ================== INITIALIZATION ==================
        async function initializeApp() {
            console.log('🚀 Initializing AI Wallet Dashboard...');
            
            // Check if MetaMask is installed
            if (!window.ethereum) {
                showNotification('⚠️ MetaMask ไม่ได้ติดตั้ง กรุณาติดตั้งก่อนใช้งาน', 'warning');
                elements.connectButton.textContent = '📥 ติดตั้ง MetaMask';
                elements.connectButton.onclick = () => {
                    window.open('https://metamask.io/download/', '_blank');
                };
                return;
            }

            // Check system health
            await checkSystemHealth();

            // Check if already connected
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    await handleAccountsChanged(accounts);
                    console.log('✅ Auto-connected to existing wallet session');
                }
            } catch (error) {
                console.error('Failed to check existing connection:', error);
            }

            console.log('✅ App initialization completed');
        }

        // ================== STARTUP ==================
        // Wait for DOM to be fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Add some developer info
        console.log(`
        🤖 AI Wallet Dashboard
        =====================================
        🔧 Backend: ${CONFIG.BACKEND_URL}
        📡 Data Flow: Browser → Backend → Alchemy → Gemini AI → Browser
        🌐 Supported Networks: ${Object.values(CONFIG.SUPPORTED_NETWORKS).join(', ')}
        🔄 Auto-refresh: ${CONFIG.REFRESH_INTERVAL / 1000}s
        =====================================
        `);
    </script>
</body>
</html>
